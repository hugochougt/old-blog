<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">

  <link rel="shortcut icon" href="/assets/images/logo.png " type="image/png">
  <link rel="icon" href="/assets/images/logo.png " type="image/png">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>meta_search 的 sort_link 方法没有对数据进行排序 | Hugo Chou 周昌权</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="meta_search 的 sort_link 方法没有对数据进行排序" />
<meta name="author" content="Hugo Chou" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="功能需求" />
<meta property="og:description" content="功能需求" />
<link rel="canonical" href="https://hugochougt.com/blog/sort-link-in-meta-search-did-not-sort-records" />
<meta property="og:url" content="https://hugochougt.com/blog/sort-link-in-meta-search-did-not-sort-records" />
<meta property="og:site_name" content="Hugo Chou 周昌权" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-05-09T15:36:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="meta_search 的 sort_link 方法没有对数据进行排序" />
<meta name="twitter:site" content="@hugochougt" />
<meta name="twitter:creator" content="@hugochougt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Hugo Chou","url":"https://hugochougt.com"},"dateModified":"2015-05-09T15:36:00+00:00","datePublished":"2015-05-09T15:36:00+00:00","description":"功能需求","headline":"meta_search 的 sort_link 方法没有对数据进行排序","mainEntityOfPage":{"@type":"WebPage","@id":"https://hugochougt.com/blog/sort-link-in-meta-search-did-not-sort-records"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://hugochougt.com/assets/images/logo.png"},"name":"Hugo Chou"},"url":"https://hugochougt.com/blog/sort-link-in-meta-search-did-not-sort-records"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <nav class="flex flex-wrap items-center justify-center px-2 py-6">
  <div class="container px-4 mx-auto flex flex-wrap items-center justify-center">
    <div class="flex md:block" id="navbar">
      <div class="flex mr-auto w-full">
        
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/">
          Home
        </a>
        
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/">
          Blog
        </a>
        
      </div>
    </div>
  </div>
</nav>


<div class="flex flex-wrap items-center justify-center mx-auto px-4 pt-4 prose prose-stone">
  <h1 class="text-center mt-6 mb-6">meta_search 的 sort_link 方法没有对数据进行排序</h1>
  <article class="py-1">
    <h2 id="功能需求">功能需求</h2>

<p>管理员在后台可以对用户的 Last Active Time 按顺序或倒序排序。</p>

<h2 id="meta_search"><a href="https://github.com/activerecord-hackery/meta_search">meta_search</a></h2>

<p>meta_search 的用法很简单：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># controller</span>
<span class="k">def</span> <span class="nf">index</span>
  <span class="vi">@search</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:search</span><span class="p">])</span>
  <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@search</span><span class="p">.</span><span class="nf">relation</span> <span class="c1"># Retrieve the relation, to lazy-load in view</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># view</span>
<span class="o">&lt;</span><span class="sx">%= sort_link @search, :last_active_at, "Last Active Time" %&gt;
</span></code></pre></div></div>

<h2 id="bug">“Bug”</h2>

<p>在页面不管怎么点击 sort link，出来的结果都是一样，并没有按预期的按照 <code class="language-plaintext highlighter-rouge">last_active_at</code> 的先后进行排序。</p>

<h2 id="debug">Debug</h2>

<p>经过 CTO 的指点，在 <code class="language-plaintext highlighter-rouge">@search</code> 变量上调用了 <code class="language-plaintext highlighter-rouge">to_sql</code> 方法，得到了 SQL 语句的结尾有 “ORDER BY id DESC”。原来没有按照 <code class="language-plaintext highlighter-rouge">last_active_at</code> 字段进行排序的原因在于 User model 里添加了 <code class="language-plaintext highlighter-rouge">default_scope { order('id DESC') }</code> 语句。</p>

<h2 id="解决方法">解决方法</h2>

<p>Rails 提供了 <code class="language-plaintext highlighter-rouge">unscoped()</code> 来取消 default_scope 的副作用。</p>

<blockquote>
  <p>ActiveRecord::Scoping::Default::ClassMethods.unscoped():</p>

  <p>Returns a scope for the model without the previously set scopes.</p>
</blockquote>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># solution</span>
<span class="k">def</span> <span class="nf">index</span>
  <span class="vi">@search</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">unscoped</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:search</span><span class="p">])</span>
  <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@search</span><span class="p">.</span><span class="nf">relation</span> <span class="c1"># Retrieve the relation, to lazy-load in view</span>
<span class="k">end</span>
</code></pre></div></div>

<p>-EOF-</p>

  </article>
</div>

    <footer class="relative px-4 pt-4 pb-4">
  <div class="flex flex-wrap items-center justify-center">
    <div class="text-sm text-gray-300">
      &copy; 2023 Hugo Chou
    </div>
  </div>
</footer>

  </body>
</html>
