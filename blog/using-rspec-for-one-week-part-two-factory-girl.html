<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">

  <link rel="shortcut icon" href="/assets/images/logo.png " type="image/png">
  <link rel="icon" href="/assets/images/logo.png " type="image/png">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>RSpec 使用一周小结（下）——使用 FactoryGirl 准备测试数据 | Hugo Chou 周昌权</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="RSpec 使用一周小结（下）——使用 FactoryGirl 准备测试数据" />
<meta name="author" content="Hugo Chou" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="八月下旬发布了 RSpec 使用一周小结（上篇），文末预告了会有下篇介绍使用 FactoryGirl 准备测试数据，现在来了。" />
<meta property="og:description" content="八月下旬发布了 RSpec 使用一周小结（上篇），文末预告了会有下篇介绍使用 FactoryGirl 准备测试数据，现在来了。" />
<link rel="canonical" href="https://hugochougt.com/blog/using-rspec-for-one-week-part-two-factory-girl" />
<meta property="og:url" content="https://hugochougt.com/blog/using-rspec-for-one-week-part-two-factory-girl" />
<meta property="og:site_name" content="Hugo Chou 周昌权" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-09-30T20:10:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="RSpec 使用一周小结（下）——使用 FactoryGirl 准备测试数据" />
<meta name="twitter:site" content="@hugochougt" />
<meta name="twitter:creator" content="@hugochougt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Hugo Chou","url":"https://hugochougt.com"},"dateModified":"2016-09-30T20:10:00+00:00","datePublished":"2016-09-30T20:10:00+00:00","description":"八月下旬发布了 RSpec 使用一周小结（上篇），文末预告了会有下篇介绍使用 FactoryGirl 准备测试数据，现在来了。","headline":"RSpec 使用一周小结（下）——使用 FactoryGirl 准备测试数据","mainEntityOfPage":{"@type":"WebPage","@id":"https://hugochougt.com/blog/using-rspec-for-one-week-part-two-factory-girl"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://hugochougt.com/assets/images/logo.png"},"name":"Hugo Chou"},"url":"https://hugochougt.com/blog/using-rspec-for-one-week-part-two-factory-girl"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <nav class="flex flex-wrap items-center justify-center px-2 py-6">
  <div class="container px-4 mx-auto flex flex-wrap items-center justify-center">
    <div class="flex md:block" id="navbar">
      <div class="flex mr-auto w-full">
        
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/">
          Home
        </a>
        
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/">
          Blog
        </a>
        
      </div>
    </div>
  </div>
</nav>


<div class="flex flex-wrap items-center justify-center mx-auto px-4 pt-4 prose prose-stone">
  <h1 class="text-center mt-6 mb-6">RSpec 使用一周小结（下）——使用 FactoryGirl 准备测试数据</h1>
  <article class="py-1">
    <p>八月下旬发布了 <a href="http://www.beansmile.com/blog/posts/using-rspec-for-one-week-part-one">RSpec 使用一周小结（上篇）</a>，文末预告了会有下篇介绍使用 FactoryGirl 准备测试数据，现在来了。</p>

<blockquote>
  <p>在自动化测试中，准备测试数据是最重要也是最麻烦的，因此我们需要一个好的管理工具来辅助生成测试数据。Rails 中的默认测试数据构件是 fixture，就是一堆 yml 文件，使用简单但不方便组织复杂的测试用例数据。
– Rain</p>
</blockquote>

<p>在这个前提下，我们使用了 <code class="language-plaintext highlighter-rouge">factory_girl</code> 这个gem，来做测试数据管理。</p>

<h2 id="在-rails-中安装-factorygirl">在 Rails 中安装 FactoryGirl</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># Provides Rails integration for factory_girl</span>
  <span class="c1"># https://github.com/thoughtbot/factory_girl_rails</span>
  <span class="n">gem</span> <span class="s1">'factory_girl_rails'</span><span class="p">,</span> <span class="s1">'~&gt; 4.7'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>在我们 Beansmile 里，所有 Rails 项目的 <code class="language-plaintext highlighter-rouge">Gemfile</code> 都要求在 gem 前加上一句简介、源码地址，然后指定 gem version 。一句简介、源码地址可以方便其他同事了解 gem 的基本用途，以及快速找到 gem 的更多信息，指定 gem version 可以避免版本冲突。</p>

<p>默认放置 factories 的文件夹是 <code class="language-plaintext highlighter-rouge">test/factories</code>。如果你使用了 RSpec 作为测试框架，那默认的 factories 文件夹则是 <code class="language-plaintext highlighter-rouge">spec/factories</code>。后面我们讨论使用 FactoryGirl 都是在测试框架是 RSpec 的前提下。</p>

<p>如果你愿意，可以将所有的 factories 都定义在 <code class="language-plaintext highlighter-rouge">spec/factories.rb</code> 文件中。但是在 Beansmile 我们都不会这样做，而是将每个 factories 以模型名复数的形式，单独保存一个文件在 <code class="language-plaintext highlighter-rouge">spec/factories</code> 文件夹下。例如有 User 和 Article 模型，那对应的 facotry 则分别是 <code class="language-plaintext highlighter-rouge">spec/factories/users.rb</code> 和 <code class="language-plaintext highlighter-rouge">spec/factories/articles.rb</code>。</p>

<h2 id="用法">用法</h2>

<h3 id="定义-factories">定义 factories</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># file: spec/factories/users.rb</span>
<span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="c1"># 根据 :user symbol 猜测使用 User model</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="s2">"John"</span>
    <span class="n">last_name</span>  <span class="s2">"Doe"</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"user</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span> <span class="p">}</span> <span class="c1"># 只要模型中有唯一性验证，就可以使用序列。</span>
    <span class="n">admin</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="c1"># 指明使用 User model</span>
  <span class="n">factory</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">class: </span><span class="no">User</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="s2">"Admin"</span>
    <span class="n">last_name</span>  <span class="s2">"User"</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"admin</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span> <span class="p">}</span>
    <span class="n">admin</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="创建-factories">创建 factories</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 创建一个未保存到数据库的实例</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="c1"># not saved to db</span>

<span class="c1"># 创建一个已保存到数据库的实例</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="c1"># saved to db</span>

<span class="c1"># 返回一个包含用于创建 User 实例的相关属性的 hash</span>
<span class="n">user_attrs</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">attributes_for</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
<span class="c1"># =&gt; {:first_name=&gt;"John", :last_name=&gt;"Doe", :email=&gt;"user1@example.com", :admin=&gt;false}</span>

<span class="c1"># 覆盖 factory 字段的默认值</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Joe"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">first_name</span>
<span class="c1"># =&gt; "Joe"</span>
</code></pre></div></div>

<h3 id="关联关系">关联关系</h3>

<p>假设有以下模型及关联关系：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File: app/model/user.rb</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:articles</span>
<span class="k">end</span>

<span class="c1"># File: app/model/article.rb</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>
</code></pre></div></div>

<p>那么在已经有 user factory 的前提下，可以使用以下简写方式创建 post 的 factory：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:post</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Post title</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>也可以使用完整的写法关联对应的 factory，同时覆盖一些默认属性：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:post</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">"Post title</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
    <span class="n">association</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">factory: :user</span><span class="p">,</span> <span class="ss">last_name: </span><span class="s2">"Writely"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">:post</span><span class="p">)</span>
<span class="n">post</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">last_name</span> <span class="c1"># =&gt; "Writely"</span>
</code></pre></div></div>

<h3 id="transients">Transients</h3>

<p><code class="language-plaintext highlighter-rouge">transient</code> 可用来定义临时/假<em>属性</em>。用 <code class="language-plaintext highlighter-rouge">transient</code> 定义的是属性名字。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="s2">"John"</span>
    <span class="n">last_name</span>  <span class="s2">"Doe"</span>
  <span class="k">end</span>

  <span class="n">transient</span> <span class="k">do</span>
    <span class="n">with_posts</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="n">after</span> <span class="ss">:create</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span>
    <span class="n">create_list</span><span class="p">(</span><span class="ss">:post</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">user: </span><span class="n">user</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span><span class="p">.</span><span class="nf">with_posts</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Usage:</span>
<span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">with_posts: </span><span class="kp">true</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="traits">Traits</h3>

<p><code class="language-plaintext highlighter-rouge">trait</code> 是用来定义特征<em>数据样例</em>的。用 <code class="language-plaintext highlighter-rouge">trait</code> 定义的是数据样例名字，命名一般是使用形容词或名词，如“未确认的(用户)”。</p>

<p><code class="language-plaintext highlighter-rouge">trait</code> 是非常实用的、用于 DRY 测试用例数据的方法，在测试过程中必定会用到，其用法有以下几种：</p>

<p>定义特殊用例，例如 <code class="language-plaintext highlighter-rouge">注册了没有但验证邮箱的用户</code> 、 <code class="language-plaintext highlighter-rouge">被锁定的用户</code> 。有些测试场景需要用到这些特殊特征的用户时，就可以使用 <code class="language-plaintext highlighter-rouge">trait</code> 来定义：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
    <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
      <span class="c1"># 默认用户是已经校验过的，confirmed_at 不为空</span>
      <span class="n">confirmed_at</span> <span class="p">{</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="p">}</span>

      <span class="c1"># 注册了没有但验证邮箱的用户</span>
      <span class="n">trait</span> <span class="ss">:unconfirmed</span> <span class="k">do</span>
        <span class="n">confirmed_at</span> <span class="kp">nil</span>
      <span class="k">end</span>

      <span class="c1"># 被锁定的用户</span>
      <span class="n">trait</span> <span class="ss">:locked</span> <span class="k">do</span>
        <span class="n">locked_at</span> <span class="p">{</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Usage:</span>
  <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:unconfirmed</span>
  <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:locked</span>
</code></pre></div></div>

<p>可组合使用：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="n">traits</span> <span class="p">[</span><span class="ss">:unconfirmed</span><span class="p">,</span> <span class="ss">:locked</span><span class="p">]</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">trait</code> 可嵌套使用：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
    <span class="c1"># 正常用户用 `create :user`</span>
    <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
      <span class="n">confirmed_at</span> <span class="p">{</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="p">}</span>

      <span class="c1"># 没验证邮箱的用户</span>
      <span class="n">trait</span> <span class="ss">:unconfirmed</span> <span class="k">do</span>
        <span class="n">confirmed_at</span> <span class="kp">nil</span>
      <span class="k">end</span>

      <span class="c1"># 没验证邮箱且注册了1个月以上的认为是“僵尸用户”</span>
      <span class="n">trait</span> <span class="ss">:zombie</span> <span class="k">do</span>
        <span class="n">unconfirmed</span>
        <span class="n">created_at</span> <span class="p">{</span> <span class="mi">31</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Usage:</span>
  <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:zombie</span>
</code></pre></div></div>

<p>接受 <code class="language-plaintext highlighter-rouge">transient</code> 参数，例如有些用例指定“僵尸用户”的注册时间：</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
    <span class="c1"># 正常用户用 `create :user`</span>
    <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
      <span class="n">confirmed_at</span> <span class="p">{</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="p">}</span>

      <span class="c1"># 没验证邮箱的用户</span>
      <span class="n">trait</span> <span class="ss">:unconfirmed</span> <span class="k">do</span>
        <span class="n">confirmed_at</span> <span class="kp">nil</span>
      <span class="k">end</span>

      <span class="c1"># 没验证邮箱 且 注册了1个月以上的"僵尸"用户</span>
      <span class="n">trait</span> <span class="ss">:zombie</span> <span class="k">do</span>
        <span class="n">unconfirmed</span>
        <span class="n">created_at</span> <span class="p">{</span> <span class="mi">31</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span> <span class="p">}</span>

        <span class="n">before</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">|</span>
          <span class="c1"># 如果有registered_at有值，就用来设置created_at</span>
          <span class="nb">self</span><span class="p">.</span><span class="nf">created_at</span> <span class="o">=</span> <span class="n">evaluator</span><span class="p">.</span><span class="nf">registered_at</span> <span class="k">if</span> <span class="n">evaluator</span><span class="p">.</span><span class="nf">registered_at</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Usage:</span>
  <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:zombie</span><span class="p">,</span> <span class="ss">registered_at: </span><span class="mi">2</span><span class="p">.</span><span class="nf">months</span><span class="p">.</span><span class="nf">ago</span>
</code></pre></div></div>

<p>以上这些是我们最近在一个项目写测试时用到的 FactoryGirl 特性简介，对于其更多详细的用法，可以参考 <a href="https://github.com/thoughtbot/factory_girl/blob/master/GETTING_STARTED.md">FactoryGirl Getting Started</a>。</p>

<p><strong>20160923 Edited</strong>:</p>

<p>Rain 提供了 <code class="language-plaintext highlighter-rouge">Transients</code> 和 <code class="language-plaintext highlighter-rouge">Traits</code> 两部分的说明及代码示例。</p>

<p>P.S. 首发于 <a href="http://beansmile.com/blog">Beansmile 官方博客</a>，一周后转载于自己的博客。</p>

<h2 id="参考资料">参考资料</h2>

<ol>
  <li><a href="https://github.com/thoughtbot/factory_girl/blob/master/GETTING_STARTED.md">FactoryGirl Getting Started</a></li>
  <li><a href="http://ricostacruz.com/cheatsheets/factory_girl.html">Cheatsheet for FactoryGirl</a></li>
</ol>

<p>-EOF-</p>

  </article>
</div>

    <footer class="relative px-4 pt-4 pb-4">
  <div class="flex flex-wrap items-center justify-center">
    <div class="text-sm text-gray-300">
      &copy; 2023 Hugo Chou
    </div>
  </div>
</footer>

  </body>
</html>
