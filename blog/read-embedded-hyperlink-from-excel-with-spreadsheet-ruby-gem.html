<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">

  <link rel="shortcut icon" href="/assets/images/logo.png " type="image/png">
  <link rel="icon" href="/assets/images/logo.png " type="image/png">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>使用 spreadsheet gem 读取 Excel 单元格中内嵌的 hyperlink | Hugo Chou 周昌权</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="使用 spreadsheet gem 读取 Excel 单元格中内嵌的 hyperlink" />
<meta name="author" content="Hugo Chou" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="Task" />
<meta property="og:description" content="Task" />
<link rel="canonical" href="https://hugochougt.com/blog/read-embedded-hyperlink-from-excel-with-spreadsheet-ruby-gem" />
<meta property="og:url" content="https://hugochougt.com/blog/read-embedded-hyperlink-from-excel-with-spreadsheet-ruby-gem" />
<meta property="og:site_name" content="Hugo Chou 周昌权" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-01-11T10:44:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="使用 spreadsheet gem 读取 Excel 单元格中内嵌的 hyperlink" />
<meta name="twitter:site" content="@hugochougt" />
<meta name="twitter:creator" content="@hugochougt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Hugo Chou","url":"https://hugochougt.com"},"dateModified":"2015-01-11T10:44:00+00:00","datePublished":"2015-01-11T10:44:00+00:00","description":"Task","headline":"使用 spreadsheet gem 读取 Excel 单元格中内嵌的 hyperlink","mainEntityOfPage":{"@type":"WebPage","@id":"https://hugochougt.com/blog/read-embedded-hyperlink-from-excel-with-spreadsheet-ruby-gem"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://hugochougt.com/assets/images/logo.png"},"name":"Hugo Chou"},"url":"https://hugochougt.com/blog/read-embedded-hyperlink-from-excel-with-spreadsheet-ruby-gem"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <nav class="flex flex-wrap items-center justify-center px-2 py-6">
  <div class="container px-4 mx-auto flex flex-wrap items-center justify-center">
    <div class="flex md:block" id="navbar">
      <div class="flex mr-auto w-full">
        
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/">
          Home
        </a>
        
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/">
          Blog
        </a>
        
      </div>
    </div>
  </div>
</nav>


<div class="flex flex-wrap items-center justify-center mx-auto px-4 pt-4 prose prose-stone">
  <h1 class="text-center mt-6 mb-6">使用 spreadsheet gem 读取 Excel 单元格中内嵌的 hyperlink</h1>
  <article class="py-1">
    <h3 id="task">Task</h3>

<p>读取 xls 后缀的 MS Excel 文件中单元格的内容及内嵌其中的 hyperlink。</p>

<h3 id="solution">Solution</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'spreadsheet'</span>

<span class="n">excel</span> <span class="o">=</span> <span class="no">Spreadsheet</span><span class="p">.</span><span class="nf">open</span> <span class="s2">"/path/to/excel.xls"</span>
<span class="n">sheet</span> <span class="o">=</span> <span class="n">excel</span><span class="p">.</span><span class="nf">worksheet</span> <span class="s2">"sheet_name"</span>

<span class="n">sheet</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">respong_to?</span><span class="p">(</span><span class="ss">:href</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">href</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>（假设第一列的单元格都内嵌了 hyperlink。）</p>

<p><a href="https://github.com/zdavatz/spreadsheet">spreadsheet</a> 文档中有写到：</p>

<blockquote>
  <p>To access the values stored in a Row, treat the Row like an Array.
row[0]
-&gt; this will return a String, a Float, an Integer, a Formula, a Link or a Date or DateTime object - or nil if the cell is empty.</p>
</blockquote>

<p>如果某个单元格内嵌了 hyperlink，<code class="language-plaintext highlighter-rouge">row[i]</code> 就会直接返回 <a href="http://www.rubydoc.info/gems/ruby-spreadsheet/Spreadsheet/Link">Spreadsheet::Link</a> class，然后可以通过 <code class="language-plaintext highlighter-rouge">#url</code> 或 <code class="language-plaintext highlighter-rouge">#href</code> (url with fragment appended if present) 来获取内嵌的 hyperlink。</p>

<h3 id="-tldr-">=== tl;dr ===</h3>

<p>上面是经过简化的内容，只专注标题的意思。下面就啰嗦一下，讲讲整个过程。</p>

<p>Task 本来是要读取一个 xlsx 格式的 Excel，里面是一列几千条的学校名字数据，学校名字内嵌了该校主页的链接，最终目的是读取学校名和主页 hyperlink，存到数据库里以备后用。</p>

<p>一开始是先使用 spreadsheet gem 的，试了一下就发现其不能打开 xlsx 格式的 Excel。将源文件转换成 xls 格式后，能读取数据。然后看了文档很久也没有发现怎么在读取单元格的同时，读取其内嵌的 hyperlink。只是发现有 Spreadsheet::Link 这个类，但是文档里写的却是关于<strong>写</strong>单元格的事例，没有读取的说明。</p>

<p>后来通过使用 pry 来 debug，才发现原来当单元格内嵌了 hyperlink，<code class="language-plaintext highlighter-rouge">row[i]</code> 就会返回 Spreadsheet::Link class（通过运行 <code class="language-plaintext highlighter-rouge">row[i].class</code> 命令知道的）。虽然调用 <code class="language-plaintext highlighter-rouge">row[i].href</code> 能拿到链接了，但是返回值却有乱码（类似 “http://homepage.com/烫烫\u1234\u5678” 的字符串，前面纯 ASCII 字符部分是正确的，只是后面多了一些汉字和 unicode）。</p>

<p>发现读取的值不太对后，就转而尝试 <a href="https://github.com/roo-rb/roo">Roo</a> 这个可以直接读取 xlsx 格式的 gem。看了一圈文档并写了一些实验性代码后，没有发现读取单元格内嵌链接的接口。</p>

<p>最终就又切换回使用 spreadsheet 这个 gem，使用 regex 只匹配出 ASCII 字符来去掉乱码。最终进入代码库的 regex：</p>

<p>/[:.\/\w\d]+/</p>

<p>-EOF-</p>

  </article>
</div>

    <footer class="relative px-4 pt-4 pb-4">
  <div class="flex flex-wrap items-center justify-center">
    <div class="text-sm text-gray-300">
      &copy; 2023 Hugo Chou
    </div>
  </div>
</footer>

  </body>
</html>
