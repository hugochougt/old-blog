<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/syntax.css">

  <link rel="shortcut icon" href="/assets/images/logo.png " type="image/png">
  <link rel="icon" href="/assets/images/logo.png " type="image/png">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>基于腾讯云服务的 Rails 负载均衡部署方案简介 | Hugo Chou 周昌权</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="基于腾讯云服务的 Rails 负载均衡部署方案简介" />
<meta name="author" content="Hugo Chou" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="最近应客户要求，将网站的单机部署架构，改为了双机负载均衡架构，以提高整个系统的可用性。" />
<meta property="og:description" content="最近应客户要求，将网站的单机部署架构，改为了双机负载均衡架构，以提高整个系统的可用性。" />
<link rel="canonical" href="https://hugochougt.com/blog/rails-loadbalance-deployment-based-on-qcloud-service" />
<meta property="og:url" content="https://hugochougt.com/blog/rails-loadbalance-deployment-based-on-qcloud-service" />
<meta property="og:site_name" content="Hugo Chou 周昌权" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-07-29T20:32:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="基于腾讯云服务的 Rails 负载均衡部署方案简介" />
<meta name="twitter:site" content="@hugochougt" />
<meta name="twitter:creator" content="@hugochougt" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Hugo Chou","url":"https://hugochougt.com"},"dateModified":"2016-07-29T20:32:00+00:00","datePublished":"2016-07-29T20:32:00+00:00","description":"最近应客户要求，将网站的单机部署架构，改为了双机负载均衡架构，以提高整个系统的可用性。","headline":"基于腾讯云服务的 Rails 负载均衡部署方案简介","mainEntityOfPage":{"@type":"WebPage","@id":"https://hugochougt.com/blog/rails-loadbalance-deployment-based-on-qcloud-service"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://hugochougt.com/assets/images/logo.png"},"name":"Hugo Chou"},"url":"https://hugochougt.com/blog/rails-loadbalance-deployment-based-on-qcloud-service"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <nav class="flex flex-wrap items-center justify-center px-2 py-6">
  <div class="container px-4 mx-auto flex flex-wrap items-center justify-center">
    <div class="flex md:block" id="navbar">
      <div class="flex mr-auto w-full">
        
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/">
          Home
        </a>
        
        <a class="text-sm text-gray-500 hover:text-gray-900 px-3 py-2 lg:py-1 mx-auto uppercase"
          href="/blog/">
          Blog
        </a>
        
      </div>
    </div>
  </div>
</nav>


<div class="flex flex-wrap items-center justify-center mx-auto px-4 pt-4 prose prose-stone">
  <h1 class="text-center mt-6 mb-6">基于腾讯云服务的 Rails 负载均衡部署方案简介</h1>
  <article class="py-1">
    <p>最近应客户要求，将网站的单机部署架构，改为了双机负载均衡架构，以提高整个系统的可用性。</p>

<h2 id="方案一自建方案">方案一、自建方案</h2>

<h3 id="11-负载均衡keepalived--nginx--haproxy">1.1 负载均衡：Keepalived + Nginx + HAproxy</h3>

<p>自建负载均衡方案的主要原理是，在每一处有单点故障风险的地方（如 Web server、Rails app server、数据库等），都使用 keepalived 配置至少两个独立进程，防止其中一个服务宕机后，导致整个网站不可访问。</p>

<p>参考资料：</p>

<ul>
  <li><a href="https://sleekd.com/general/keepalived_nginx_haproxy_thin_ruby_on_rails/">Setting up a High Availability Ruby on Rails environment with keepalived, nginx, HA Proxy and Thin on Debian Lenny</a></li>
  <li><a href="http://www.tokiwinter.com/building-a-highly-available-load-balancer-with-nginx-and-keepalived-on-centos/">Building a Highly-Available Load Balancer with Nginx and Keepalived on CentOS
</a></li>
  <li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-highly-available-web-servers-with-keepalived-and-floating-ips-on-ubuntu-14-04">How To Set Up Highly Available Web Servers with Keepalived and Floating IPs on Ubuntu 14.04</a></li>
</ul>

<h3 id="12-数据库高可用mysql-mha">1.2 数据库高可用：MySQL MHA</h3>

<p>MySQL 数据库高可用的架构，考虑到一般网站的访问量、对 down time 的要求和各种架构配置的复杂度，采用 <a href="https://code.google.com/p/mysql-master-ha/">MySQL MHA</a> 比较合适。</p>

<p>参考资料：</p>

<ul>
  <li><a href="http://blog.csdn.net/largetalk/article/details/10006899">MySQL HA方案: MHA</a></li>
  <li><a href="https://code.google.com/p/mysql-master-ha/wiki/Other_HA_Solutions">其他 MySQL 高可用方案及其问题</a></li>
  <li><a href="http://zhaqiang.github.io/mysql/high%20availability/2014/01/13/high-availability-solutions-for-mysql/">MySQL 高可用解决方案简介</a></li>
  <li><a href="http://blog.chinaunix.net/uid-20726500-id-5473292.html">如何防止HA集群的脑裂</a></li>
</ul>

<h3 id="自建方案架构图">自建方案架构图</h3>

<p><img src="/images/posts/self-build-network-design-chart.jpg" alt="自建方案架构图" /></p>

<h3 id="自建方案费用">自建方案费用</h3>

<p>单台 VPS：￥65元/月</p>

<p>最低费用：(Nginx/App Servers x 2 ＋ MySQL DBs x 2 + MHA Manager x 1) x ￥65元/月/台 = ￥325元/月</p>

<h3 id="优点">优点</h3>

<ul>
  <li>部署、运维人员对系统有完整的掌控权</li>
  <li>Keepalived 提供了失效切换的 callback 功能，可以在服务器宕机时执行脚本，例如发送通知邮件、尝试重启服务器等</li>
</ul>

<h3 id="缺点">缺点</h3>

<ul>
  <li>由于网络较为复杂，对部署、运维人员的能力要求较高</li>
  <li>相对方案二，硬件成本也比较高</li>
</ul>

<h2 id="方案二购买腾讯云服务方案推荐并且已实施的部署方案">方案二、购买腾讯云服务方案（推荐并且已实施的部署方案）</h2>

<h3 id="21-腾讯云负载均衡">2.1 <a href="https://www.qcloud.com/doc/product/214/%E6%A6%82%E8%BF%B0">腾讯云负载均衡</a></h3>

<p>费用：</p>

<ul>
  <li>负载均衡实例费用 ：公网有日租：1元/天</li>
  <li>负载均衡带宽费用：
    <ul>
      <li>云服务器按带宽计费：带宽消耗使用的是云服务器已包含的公网带宽，不另外收取带宽费用；</li>
      <li>云服务器按流量计费：用户使用公网负载均衡会产生出流量，需支付对应的流量费用。</li>
    </ul>
  </li>
</ul>

<p><a href="https://www.qcloud.com/doc/product/213/%E8%B4%AD%E4%B9%B0%E7%BD%91%E7%BB%9C%E5%B8%A6%E5%AE%BD">网络计费说明</a></p>

<h3 id="22-腾讯云的云数据库-cdb-for-mysql">2.2 腾讯云的<a href="https://www.qcloud.com/product/cdb.html">云数据库 CDB for MySQL</a></h3>

<p>费用：</p>

<ul>
  <li>推荐配置：高IO型，容量25GB，内存1000MB</li>
  <li>费用：112元/月/台</li>
</ul>

<h3 id="架构图">架构图</h3>

<p><img src="/images/posts/qcloud-service-network-design-chart.jpg" alt="腾讯云服务方案网络架构图" /></p>

<h3 id="最低费用总计">最低费用总计</h3>

<p>负载均衡实例费用30元/月/个 + 云数据库 CDB for MySQL 112元/月/台 + App Servers x 2 x 65元/月/台 = 272元/月</p>

<h3 id="优点-1">优点</h3>

<ul>
  <li>降低系统的配置、管理复杂度</li>
  <li>数据库实时双机热备，故障秒级切换。不需自建主从，自建 RAID（腾讯云数据库的产品说明）</li>
  <li>费用相对自建方案便宜</li>
</ul>

<h3 id="缺点-1">缺点</h3>

<ul>
  <li>腾讯云的负载均衡在检查到服务器失效后，没有提供 callback 的功能，导致在失效切换时不能进行一些自定义操作</li>
</ul>

<h2 id="结论">结论</h2>

<p>综合考虑费用、维护复杂度等因素，最终我们选择了方案二来实施双机负载均衡部署。</p>

<h2 id="遇到的问题">遇到的问题</h2>

<h3 id="问题一图片存储已解决">问题一：图片存储（已解决）</h3>

<p>原有的单机架构是使用 <code class="language-plaintext highlighter-rouge">carrierwave</code> gem 将图片存储在服务器本地，那在某个用户某次访问网站更新图片后，图片被存储在了服务器1上。假如后来服务器1宕机了，那图片就会丢失了。</p>

<p>解决办法就是使用<a href="https://www.qcloud.com/product/cos.html">腾讯云对象存储服务 COS </a>。迁移图片到腾讯云 COS 也费了点时间。我厂 CTO Rain 还为此写了支持腾讯云 COS 存储的 carrierwave gem 插件：<a href="https://github.com/rainchen/carrierwave-qcloud">carrierwave-qcloud</a>。</p>

<h3 id="问题二计划任务暂未解决">问题二：计划任务（暂未解决）</h3>

<p>使用 <code class="language-plaintext highlighter-rouge">capistrano</code> 结合 <code class="language-plaintext highlighter-rouge">whenever</code> 部署 Rails 的后台定时任务，crontab 配置只会生成在 db role 为 primary 的服务器，这里又是一个单点故障的地方。</p>

<p>计划任务这个单点故障的地方，因为时间关系在最终的部署方案里没有做成高可用架构。设想的方案是配合 redis 部署一个高可用的定时任务服务器。</p>

<p><em>P.S. 本文首发于 Beansmile 官方 blog <a href="http://www.beansmile.com/blog/posts/rails-loadbalance-deployment">基于腾讯云服务的 Rails 负载均衡部署方案简介</a>，一周后发布于我自己的 blog。</em></p>

<p>-EOF-</p>

  </article>
</div>

    <footer class="relative px-4 pt-4 pb-4">
  <div class="flex flex-wrap items-center justify-center">
    <div class="text-sm text-gray-300">
      &copy; 2023 Hugo Chou
    </div>
  </div>
</footer>

  </body>
</html>
